define(["jquery","core/ajax"],function(a,b){var c={showDialog:function(b,c,d,e){if(a("#dlg_title").html(b),a("#dlg_body").html(c),d&&d(),e){for(var f="",g=0;g<e.length;g++){var h=e[g];f+='<button class="btn btn-secondary" id="dlg_btn_'+h.id+'" '+(h.close?'data-dismiss="modal"':"")+">"+h.text+"</button> "}a("#dlg_footer").html(f);for(var g=0;g<e.length;g++){var h=e[g];h.onClick&&a("#dlg_btn_"+h.id).click(h.onClick)}}else a("#dlg_footer").html('<button class="btn btn-secondary" id="dlg_btn_close" data-dismiss="modal">Close</button>');a("#dlg").show().modal()},trackinit:function(d,e,f,g){function h(){a(".rating_td").click(function(d){parts=d.currentTarget.id.split("_");var e=parts[3];if(e){var f=parts[2];c.showDialog("Summary","Loading...");var h=b.call([{methodname:"mod_skillsaudit_get_activity_summary",args:{cmid:g,userid:e,skillid:f}}]);h[0].done(function(b){a("#dlg_body").html(b)})}})}function i(){var c=a("#select_group").val(),d=a("#highlight").val(),e=b.call([{methodname:"mod_skillsaudit_update_tracker",args:{cmid:g,groupid:c,highlight:d}}]);e[0].done(function(b){a("#tracker_table").html(b),h()})}a("#btn_update_progress_tracker").click(function(){i()}),a("#select_group").change(i),a("#highlight").change(i),a("#autorefresh").change(function(){var b=1e3*a(this).val();clearInterval(c.trackUpdateInterval),b>0&&(c.trackUpdateInterval=setInterval(i,b))}),h()},viewinit:function(d,e,f,g){function h(d){var e=d.currentTarget.id.replace("btn_delete_","");c.showDialog("Confirm delete","Are you sure you want to delete this rating?<p>If you press save, there's no way to undo this action</p>",null,[{id:"save",text:"Save",close:!0,onClick:function(){var c=b.call([{methodname:"mod_skillsaudit_delete_rating",args:{cmid:g,ratingid:e}}]);c[0].done(function(b){b.ratingID==e&&a("#rating_"+e).remove(),a(".skillsaudit_user_summary").html(b.summaryHtml);var c=a("#skill_row_"+o+" .minithumb").last().attr("data-confidence");c||(c=0);var d=Math.round(120*c/100);a("#conf_ind_"+o).css({width:c+"%",background:"linear-gradient(to right,red,hsl("+d+",100%,50%)"});var f=a("#skill_row_"+o).find(".rating").length;a("#rating_stats_"+o+" .rating_count").text(f),a("#skill_row_"+o+" .latest_rating_time").text("Last rated: today")})}},{id:"cancel",text:"Cancel",close:!0}])}function i(d){var e=d.currentTarget.id.replace("btn_clear_","");c.showDialog("Confirm clear","Are you sure you want to clear this comment?<p>If you press save, there's no way to undo this action</p>",null,[{id:"clear",text:"Clear",close:!0,onClick:function(){var c=b.call([{methodname:"mod_skillsaudit_clear_rating",args:{cmid:g,ratingid:e}}]);c[0].done(function(b){b==e&&a("#rating_"+e+" .rating_comment").remove()})}},{id:"cancel",text:"Cancel",close:!0}])}function j(b){var c=120*b/100,d=180-180*b/100;a("#main_indicator").css({left:b+"%"}).find(".thumb").css({"background-color":"hsl("+c+",100%,50%)",transform:"rotate("+d+"deg)"})}function k(b){o=b,a(".skill_row").not("#skill_row_"+b).fadeOut(),a("#skill_row_"+b+" .ratings").slideDown(),n=0,e&&e[b]&&e[b].confidence&&(n=e[b].confidence),j(n),a("#controls, #skill_row_"+b).fadeIn()}function l(c){var g=Math.round(120*n/100);a("#conf_ind_"+o).css({width:n+"%",background:"linear-gradient(to right,red,hsl("+g+",100%,50%)"}).parent().attr("title",n+"%"),e[o].confidence=n;var j=a("#id_comment").val(),k=b.call([{methodname:"mod_skillsaudit_save_confidence",args:{courseid:d,skillid:o,confidence:n,comment:j,auditid:f}}]);k[0].done(function(b){a("#skill_row_"+o+" .ratings .new_ratings").append(b.ratingHtml),a("#skill_row_"+o+" .skillnumber").addClass("skill_included_yes"),a(".btn_delete").unbind("click").click(h),a(".btn_clear").unbind("click").click(i),a(".skillsaudit_user_summary").html(b.summaryHtml);var d=a("#skill_row_"+o).find(".rating").length;a("#rating_stats_"+o+" .rating_count").text(d),a("#skill_row_"+o+" .latest_rating_time").text("Last rated: today"),c&&c()})}function m(){a("#controls").fadeOut(),a("#skill_row_"+o+" .ratings").slideUp(),a(".skill_row").fadeIn(),o=-1}var n=0,o=-1;a(".btn_delete").click(h),a(".btn_clear").click(i),a("#btn_save_confidence").click(function(){l(m)}),a(".skill_row").click(function(a){var b=a.currentTarget.id.replace("skill_row_","");k(b)}),a("#btn_show_all").click(m),a("#btn_show_next").click(function(b){l(function(){var b=a("#skill_row_"+o).next().attr("id");m(),b&&k(b.replace("skill_row_",""))})}),a("#controls").hide(),a(".btn_hide_comments").click(function(){return a("#skill_row_"+o+" .ratings").slideUp(),!1}),a(".btn_cancel").click(function(){return m(),!1});var p=a(".btn_confidence");a(".btn_anim").click(function(a){var b=a.currentTarget.id.replace("btn_confidence_","");n=Math.round(100*b/(p.length-1)),j(n)})},forminit:function(d,e){function f(){var b="";a(".skill_included_yes").each(function(a,c){b=b+c.id.replace("skill_included_","")+","}),b=b.replace(/,$/,""),a("input[name='skills']").val(b)}function g(b){var c=a(b.target);c.hasClass("skill_included_yes")?(c.removeClass("skill_included_yes"),c.addClass("skill_included_no")):(c.removeClass("skill_included_no"),c.addClass("skill_included_yes"),url=c.attr("src")),f()}function h(e){for(var f=a(e.target),g=0;!(f.attr("id").match(/skill_row_/)||g++>4);)f=f.parent();var h=f.attr("id").replace("skill_row_",""),i=f.find(".skill_number").text(),j=f.find(".skill_description").text(),k=f.find(".skill_help_link").attr("href");c.showDialog("Edit skill",'<h3>Note:</h3>Editing a skill here will affect all skills audits that include that skill in this course<div class="form-group"><label for="skill_edit_number"><h4>Spec. number:</h4></label><input class="form-control" id="skill_edit_number" value="'+i+'"></div><div class="form-group"><label for="skill_edit_description"><h4>Description:</h4></label><input class="form-control" id="skill_edit_description" value="'+j+'"><label for="skill_edit_link"><h4>Help link:</h4></label><input class="form-control" id="skill_edit_link" value="'+k+'"><h3>Warning</h3>Deleting this skill cannot be undone. It will remove the skill from this audit and any others in this course.',null,[{id:"save",text:"Save",close:!0,onClick:function(){j=a("#skill_edit_description").val(),i=a("#skill_edit_number").val(),helpLink=a("#skill_edit_link").val();var c=b.call([{methodname:"mod_skillsaudit_edit_skill",args:{courseid:d,skillid:h,number:i,description:j,link:helpLink}}]);c[0].done(function(a){f.find(".skill_description").text(j),helpLink.length>0&&(i='<span class="info_icon"></span>'+i),f.find(".skill_help_link").attr("href",helpLink).html(i)})}},{id:"delete",text:"Delete",close:!0,onClick:function(){var c=b.call([{methodname:"mod_skillsaudit_delete_skill",args:{courseid:d,skillid:h}}]);c[0].done(function(b){a("#skill_row_"+h).remove()})}},{id:"cancel",text:"Cancel",close:!0}])}a("#id_selectall").click(function(){a(".skill_included").removeClass("skill_included_no").addClass("skill_included_yes"),f()}),a("#id_selectnone").click(function(){a(".skill_included").removeClass("skill_included_yes").addClass("skill_included_no"),f()}),a("#id_deleteunused").click(function(){c.showDialog("Confirm delete","Are you sure you want to delete all skills that aren't used in this course?<p>If you press save, there's no way to undo this action</p>",null,[{id:"delete",text:"Delete",close:!0,onClick:function(){var c=[];a(".skill_included_no").each(function(a,b){c.push(b.id.replace("skill_included_",""))});var e=b.call([{methodname:"mod_skillsaudit_delete_unused_skills",args:{courseid:d,skillids:c.join(",")}}]);e[0].done(function(b){for(var c=b.split(","),d=0;d<c.length;d++)a("#skill_row_"+c[d]).remove()})}},{id:"cancel",text:"Cancel",close:!0}])}),a(".skill_included").click(g),a(".skill_row").dblclick(h),a("#id_addnew").click(function(){var e=[];c.showDialog("Check new skills",'<div id="skills_preview">',function(){var b=a("#id_newskills").val().split("\n"),c='<table class="generaltable"><tr><th>Number</th><th>Description</th><th>Help link</th></tr>';a.each(b,function(a,b){var d=b.match(/^([^ ]*) (.*?)(https?:\/\/[^ ]*)?$/),f="",g="",h=b;d&&d.length>2&&(f=d[1].trim(),h=d[2].trim(),d.length>3&&(g=d[3].trim()));var i="";g.length>0&&(i+='<a href="'+g+'" target="_blank"><span class="info_icon"></span></a>'),e.push({number:f,description:h,link:g}),c+="<tr><td>"+f+"</td><td>"+h+"</td><td>"+i+"</td></tr>"}),c+="</table>",a("#skills_preview").html(c)},[{id:"add",text:"Add",close:!0,onClick:function(){var c=b.call([{methodname:"mod_skillsaudit_add_skills",args:{courseid:d,skills:e}}]);c[0].done(function(b){var c=a("#tbl_skills");a.each(b,function(b,d){c.append('<tr class="skill_row" id="skill_row_'+d.id+'"><td class="skill_number"><a class="skill_help_link" href="'+d.link+'">'+(d.link.length>0?'<span class="info_icon"></span>':"")+d.number+'</a></td><td class="skill_description">'+d.description+'</td><td><span id="skill_included_'+d.id+'" class="skill_included_yes skill_included"></span></td></tr>'),a("#skill_included_"+d.id).click(g),a("#skill_row_"+d.id).dblclick(h)}),f(),a("#id_newskills").val("")}).fail(function(b){a("#skills_preview").html("Could not add skill")})}},{id:"cancel",text:"Cancel",close:!0}])})}};return c});