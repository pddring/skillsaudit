define(["jquery","core/modal_factory","core/modal_events","core/ajax"],function(a,b,c,d){var e={trackinit:function(c,f,g,h){function i(){a(".rating_td").click(function(c){parts=c.currentTarget.id.split("_");var e=parts[3],f=parts[2];a("#modal_activity_summary").remove(),b.create({type:b.types.CANCEL,title:"Ratings",body:'<div id="modal_activity_summary">Loading...</div>'}).done(function(b){b.show();var c=d.call([{methodname:"mod_skillsaudit_get_activity_summary",args:{cmid:h,userid:e,skillid:f}}]);c[0].done(function(b){a("#modal_activity_summary").html(b)})})})}function j(){var b=a("#select_group").val(),c=a("#highlight").val(),e=d.call([{methodname:"mod_skillsaudit_update_tracker",args:{cmid:h,groupid:b,highlight:c}}]);e[0].done(function(b){a("#tracker_table").html(b),i()})}a("#btn_update_progress_tracker").click(function(){j()}),a("#select_group").change(j),a("#highlight").change(j),a("#autorefresh").change(function(){var b=1e3*a(this).val();clearInterval(e.trackUpdateInterval),b>0&&(e.trackUpdateInterval=setInterval(j,b))}),i()},viewinit:function(e,f,g,h){function i(e){var f=e.currentTarget.id.replace("btn_delete_","");b.create({type:b.types.SAVE_CANCEL,title:"Confirm delete",body:"Are you sure you want to delete this rating?<p>If you press save, there's no way to undo this action</p>"}).done(function(b){b.show();var e=b.getRoot();e.on(c.save,function(b){var c=d.call([{methodname:"mod_skillsaudit_delete_rating",args:{cmid:h,ratingid:f}}]);c[0].done(function(b){b.ratingID==f&&a("#rating_"+f).remove(),a(".skillsaudit_user_summary").html(b.summaryHtml);var c=a("#skill_row_"+p+" .minithumb").last().attr("data-confidence");c||(c=0);var d=Math.round(120*c/100);a("#conf_ind_"+p).css({width:c+"%",background:"linear-gradient(to right,red,hsl("+d+",100%,50%)"});var e=a("#skill_row_"+p).find(".rating").length;a("#rating_stats_"+p+" .rating_count").text(e),a("#skill_row_"+p+" .latest_rating_time").text("Last rated: today")})})})}function j(e){var f=e.currentTarget.id.replace("btn_clear_","");b.create({type:b.types.SAVE_CANCEL,title:"Confirm clear",body:"Are you sure you want to clear this comment?<p>If you press save, there's no way to undo this action</p>"}).done(function(b){b.show();var e=b.getRoot();e.on(c.save,function(b){var c=d.call([{methodname:"mod_skillsaudit_clear_rating",args:{cmid:h,ratingid:f}}]);c[0].done(function(b){b==f&&a("#rating_"+f+" .rating_comment").remove()})})})}function k(b){var c=120*b/100,d=180-180*b/100;a("#main_indicator").css({left:b+"%"}).find(".thumb").css({"background-color":"hsl("+c+",100%,50%)",transform:"rotate("+d+"deg)"})}function l(b){p=b,a(".skill_row").not("#skill_row_"+b).fadeOut(),a("#skill_row_"+b+" .ratings").slideDown(),o=0,f&&f[b]&&f[b].confidence&&(o=f[b].confidence),k(o),a("#controls, #skill_row_"+b).fadeIn()}function m(b){var c=Math.round(120*o/100);a("#conf_ind_"+p).css({width:o+"%",background:"linear-gradient(to right,red,hsl("+c+",100%,50%)"}),f[p].confidence=o;var h=a("#id_comment").val(),k=d.call([{methodname:"mod_skillsaudit_save_confidence",args:{courseid:e,skillid:p,confidence:o,comment:h,auditid:g}}]);k[0].done(function(c){a("#skill_row_"+p+" .ratings .new_ratings").append(c.ratingHtml),a("#skill_row_"+p+" .skillnumber").addClass("skill_included_yes"),a(".btn_delete").unbind("click").click(i),a(".btn_clear").unbind("click").click(j),a(".skillsaudit_user_summary").html(c.summaryHtml);var d=a("#skill_row_"+p).find(".rating").length;a("#rating_stats_"+p+" .rating_count").text(d),a("#skill_row_"+p+" .latest_rating_time").text("Last rated: today"),b&&b()})}function n(){a("#controls").fadeOut(),a("#skill_row_"+p+" .ratings").slideUp(),a(".skill_row").fadeIn(),p=-1}var o=0,p=-1;a(".btn_delete").click(i),a(".btn_clear").click(j),a("#btn_save_confidence").click(function(){m(n)}),a(".skill_row").click(function(a){var b=a.currentTarget.id.replace("skill_row_","");l(b)}),a("#btn_show_all").click(n),a("#btn_show_next").click(function(b){m(function(){var b=a("#skill_row_"+p).next().attr("id");n(),b&&l(b.replace("skill_row_",""))})}),a("#controls").hide(),a(".btn_hide_comments").click(function(){return a("#skill_row_"+p+" .ratings").slideUp(),!1}),a(".btn_cancel").click(function(){return n(),!1});var q=a(".btn_confidence");a(".btn_anim").click(function(a){var b=a.currentTarget.id.replace("btn_confidence_","");o=Math.round(100*b/(q.length-1)),k(o)})},forminit:function(e,f){function g(){var b="";a(".skill_included_yes").each(function(a,c){b=b+c.id.replace("skill_included_","")+","}),b=b.replace(/,$/,""),a("input[name='skills']").val(b)}function h(b){var c=a(b.target);c.hasClass("skill_included_yes")?(c.removeClass("skill_included_yes"),c.addClass("skill_included_no")):(c.removeClass("skill_included_no"),c.addClass("skill_included_yes"),url=c.attr("src")),g()}function i(f){for(var g=a(f.target),h=0;!(g.attr("id").match(/skill_row_/)||h++>4);)g=g.parent();var i=g.attr("id").replace("skill_row_",""),j=g.find(".skill_number").text(),k=g.find(".skill_description").text();b.create({type:b.types.SAVE_CANCEL,title:"Edit skill",body:'<h3>Note:</h3>Editing a skill here will affect all skills audits that include that skill in this course<h4>Spec. number:</h4><input id="skill_edit_number" value="'+j+'"><h4>Description</h4><input id="skill_edit_description" value="'+k+'"><h3>Warning</h3>Deleting this skill cannot be undone. It will remove the skill from this audit and any others in this course.<p><button id="btn_delete_skill">Delete</button></p>'}).done(function(b){b.show(),a("#btn_delete_skill").click(function(c){var f=d.call([{methodname:"mod_skillsaudit_delete_skill",args:{courseid:e,skillid:i}}]);f[0].done(function(b){a("#skill_row_"+i).remove()}),b.hide(),b.destroy()});var f=b.getRoot();f.on(c.save,function(b){k=a("#skill_edit_description").val(),j=a("#skill_edit_number").val();var c=d.call([{methodname:"mod_skillsaudit_edit_skill",args:{courseid:e,skillid:i,number:j,description:k}}]);c[0].done(function(a){g.find(".skill_number").text(j),g.find(".skill_description").text(k)})})})}a("#id_selectall").click(function(){a(".skill_included").removeClass("skill_included_no").addClass("skill_included_yes"),g()}),a("#id_selectnone").click(function(){a(".skill_included").removeClass("skill_included_yes").addClass("skill_included_no"),g()}),b.create({type:b.types.SAVE_CANCEL,title:"Confirm delete",body:"Are you sure you want to delete all skills that aren't used in this course?<p>If you press save, there's no way to undo this action</p>"},a("#id_deleteunused")).done(function(b){var f=b.getRoot();f.on(c.save,function(b){var c=[];a(".skill_included_no").each(function(a,b){c.push(b.id.replace("skill_included_",""))});var f=d.call([{methodname:"mod_skillsaudit_delete_unused_skills",args:{courseid:e,skillids:c.join(",")}}]);f[0].done(function(b){for(var c=b.split(","),d=0;d<c.length;d++)a("#skill_row_"+c[d]).remove()})})}),a(".skill_included").click(h),a(".skill_row").dblclick(i),b.create({type:b.types.SAVE_CANCEL,title:"Check new skills",body:'<div id="skills_preview">'},a("#id_addnew")).done(function(b){var f=b.getRoot(),i=[];f.on(c.save,function(b){var c=d.call([{methodname:"mod_skillsaudit_add_skills",args:{courseid:e,skills:i}}]);c[0].done(function(b){var c=a("#tbl_skills");a.each(b,function(b,d){c.append('<tr class="skill_row" id="skill_row_'+d.id+'"><td class="skill_number">'+d.number+'</td><td class="skill_description">'+d.description+'</td><td><span id="skill_included_'+d.id+'" class="skill_included_yes skill_included"></span></td></tr>'),a("#skill_included_"+d.id).click(h)}),g(),a("#id_newskills").val("")}).fail(function(b){a("#skills_preview").html("Could not add skill")})}),f.on(c.shown,function(b){var c=a("#id_newskills").val().split("\n"),d='<table class="generaltable"><tr><th>Number</th><th>Description</th></tr>';a.each(c,function(a,b){var c=b.match(/^([^ ]*) (.*)$/),e="",f=b;c&&c.length>2&&(e=c[1],f=c[2]),i.push({number:e,description:f}),d+="<tr><td>"+e+"</td><td>"+f+"</td></tr>"}),d+="</table><p>If the table above is correct, press Save Changes to add the skill(s). Otherwise, press cancel</p>",a("#skills_preview").html(d)})})}};return e});